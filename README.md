В сервисе реализован функционал: 
*  получение данных бухгалтерской отчетности (БО) с сервиса bo.nalog.ru;
*  предоставления БО клиентам.

## Технологии

- Python 3.6 + / Flask
- MongoDB 4.4.0
- RabbitMQ 3.6.10

## Бизнес Логика

![BL_Accounting_5_](uploads/e9a68bb97b4a335b605dafab3c2d7074/BL_Accounting_5_.png)

## Логика предоставления БО по GET запросу

1. Поступает запрос на /api/v1/accounting с параметром inn

     `/api/v1/accounting?inn=5405956474`

2. Проверяется есть ли данные в БД. 
    1. Найдены
        1. Сформировать БО
        2. Вернуть ответ клиенту с БО
        - Ответ / статус **код 200**

            ```json
            {
              "data": {
                "years": [
                  "2017",
                  "2018",
                  "2019"
                ],
                "accounting": {
                  "2017": {
                    "1100": null,
                    "1110": 12,
                    "1120": null,
                    "1130": 14,
                    "1140": null,
                    "...": "..."
                  },
                  "2018": {
                    "1100": null,
                    "1110": 15,
                    "1120": null,
                    "1130": 16,
                    "1140": null,
                    "...": "..."
                  },
                  "2019": {
                    "1100": null,
                    "1110": 11,
                    "1120": null,
                    "1130": 22,
                    "1140": null,
                    "...": "..."
                  }
                },
                "inn": "{inn}"
              },
              "success": true
            }
            ```

    2. Не найдены
        1. Поставить задачу найти БО в очередь RabbitMQ
        2. Вернуть ответ клиенту, что его задача в очереди
        - Ответ / статус **код 201**

            ```json
            {
              "success": true
            }
            ```

## Логика предоставления БО через WebHook (очередь)

1. Проверить есть ли на сайте данные по заданному ИНН
    1. Есть
        1. Запарсить БО
        2. Сохранить БО в БД MongoDB
        3. Сформировать JSON WebHook с БО
        - JSON

            ```json
            {
              "id": "{GUID}",
              "ms": "{service_name}",
              "event": "success",
              "time": "2020-06-08 09:12:57",
              "data": {
                "years": [
                  "2017",
                  "2018",
                  "2019"
                ],
                "accounting": {
                  "2017": {
                    "1100": null,
                    "1110": 12,
                    "1120": null,
                    "1130": 14,
                    "1140": null,
                    "...": "..."
                  },
                  "2018": {
                    "1100": null,
                    "1110": 15,
                    "1120": null,
                    "1130": 16,
                    "1140": null,
                    "...": "..."
                  },
                  "2019": {
                    "1100": null,
                    "1110": 11,
                    "1120": null,
                    "1130": 22,
                    "1140": null,
                    "...": "..."
                  }
                },
                "inn": "{inn}"
              }
            }
            ```

    2. Нет на сайте
        1. Сформировать JSON WebHook с ошибкой
        - JSON

            ```json
            {
              "id": "{GUID}",
              "ms": "{service_name}",
              "event": "error",
              "time": "2020-06-08 09:12:57",
              "data": {
                "error": {
                  "code": 404,
                  "title": "Not found",
                  "detail": "Переданный ИНН незарегистрирован в базе"
                },
                "inn": "{inn}"
              }
            }
            ```

    3. Отправить WebHook с JSON

### API запросы

- [http://127.0.0.1:5000/api/v1/accounting](http://127.0.0.1:5000/api/v1/accounting?inn=<number>)  GET

    ### Переменные

    - ***inn***, string

## Ответы от сервиса с ошибками

> Все ошибки будут подаваться с 200 статус кодом

- 422
    - Передан неверный тип данных или длина не соответствует ИНН

    ```json
    {
      "success": false,
      "error": {
        "code": 422,
        "title": "Validation Error",
        "detail": "Передан неверный ИНН"
      }
    }
    ```

- 404

    ```json
    {
      "success": false,
      "error": {
        "code": 404,
        "title": "Not found",
        "detail": "Страница не существует"
      }
    }
    ```

- 500

    ```json
    {
      "success": false,
      "error": {
        "code": 500,
        "title": "Internal Error",
        "detail": "Сервис временно недоступен"
      }
    }
    ```

## Система WebHook

> Сервис заранее должен знать куда он может посылать WebHook.

В будущем будет реализована регистрация по токену, вместе с которым будет сохраняться ссылка для WebHook.
